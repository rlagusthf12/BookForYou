<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="bookMapper">

	<resultMap id="bookResult" type="Book">
		<result column="bk_no" property="bkNo"/>
		<result column="sub_cate_no" property="subCateNo"/>
		<result column="bk_title" property="bkTitle"/>
		<result column="bk_publish" property="bkPublish"/>
		<result column="bk_date" property="bkDate"/>
		<result column="bk_price" property="bkPrice"/>
		<result column="intro_originname" property="introOriginName"/>
		<result column="intro_changename" property="introChangeName"/>
		<result column="bk_stock" property="bkStock"/>
		<result column="bk_seldate" property="bkSelDate"/>
		<result column="bk_mdate" property="bkModiDate"/>
		<result column="bk_selstatus" property="bkSelStatus"/>
		<result column="bk_age" property="bkAge"/>
		<result column="bk_gender" property="bkGender"/>
		<result column="bk_work" property="bkWork"/>
		<result column="bk_level" property="bkLevel"/>
		<result column="bk_status" property="bkStatus"/>
		<result column="writer_name" property="writerName"/>
		<result column="writer_intro" property="writerIntro"/>
		<result column="writer_origin_name" property="writerOriginName"/>
		<result column="writer_change_name" property="writerChangeName"/>
		<result column="bk_content" property="bkContent"/>
		<result column="grade_star" property="bkGrade"/>
		<result column="cart_qty" property="bkQty"/>
	</resultMap>
	
	<!-- [관리자] 전체 도서 개수 조회 (한진) -->
	<select id="selectAllListCount" resultType="_int">
		select 
			   count(*)
	      from book
	</select>

	<!-- [관리자] 전체 도서 목록 조회 (한진) -->
	<select id="selectAdminBookList" resultMap="bookResult">
		select 
		       bk_no,
		       sub_cate_no,
		       bk_title,
		       bk_publish,
		       bk_date,
		       bk_price,
		       intro_originname,
		       intro_changename,
		       bk_stock,
		       bk_seldate,
		       bk_mdate,
		       bk_selstatus,
		       bk_age,
		       bk_gender,
		       bk_work,
		       bk_level,
		       bk_status,
		       writer_name,
		       writer_intro,
		       writer_origin_name,
		       writer_change_name,
		       bk_content
		  from book
		 <choose>
		 	<when test="bkStatus == 1">
		 		where bk_status = '판매중'
		 	</when> 
		 	<when test="bkStatus == 2">
		 		where bk_status = '품절'
		 	</when>	
		 	<when test="bkStatus == 3">
		 		where bk_selstatus = 'Y'
		 	</when>
		 	<when test="bkStatus == 4">
		 		where bk_selstatus = 'N'
		 	</when>
		 </choose>
		 order
		    by 
		 <choose>
		 	<when test="array == 0">
		 		bk_date desc
		 	</when> 
		 	<when test="array == 1">
		 		bk_date asc
		 	</when>	
		 	<when test="array == 2">
		 		bk_stock desc
		 	</when>
		 	<when test="array == 3">
		 		bk_stock asc
		 	</when>
		 </choose> 
	</select>
	
	<select id="selectSearchBookCount" resultType="_int">
		select
		       count(*)
		  from book
		 where bk_selstatus = 'Y'
	 	<choose>
	 		<when test="condition == 'searchAll'">
	 			and bk_title
	 			like '%' || #{keyword} || '%'
	 			or writer_name
	 		</when>
	 		<when test="condition == 'bookTitle'">
	 			and bk_title
	 		</when>
	 		<otherwise>
	 			and writer_name
	 		</otherwise>
	 	</choose>
	 	like '%' || #{keyword} || '%'
	</select>
	
	<select id="selectSearchBook" resultMap="bookResult">
		select
		       bk_no
		     , sub_cate_no
		     , bk_title
		     , bk_publish
		     , bk_price
		     , bk_date
			 , bk_price
		     , intro_originname
		     , intro_changename
		     , bk_stock
		     , bk_seldate
		     , bk_mdate
		     , bk_selstatus
		     , bk_age
		     , bk_gender
		     , bk_work
		     , bk_level
		     , bk_status
		     , writer_name
		     , writer_intro
		     , writer_origin_name
		     , writer_change_name
		     , bk_content
		  from book
		 where bk_selstatus = 'Y'
	 	<choose>
	 		<when test="condition == 'searchAll'">
	 			and bk_title
	 			like '%' || #{keyword} || '%'
	 			or writer_name
	 		</when>
	 		<when test="condition == 'bookTitle'">
	 			and bk_title
	 		</when>
	 		<otherwise>
	 			and writer_name
	 		</otherwise>
	 	</choose>
	 			like '%' || #{keyword} || '%'
	</select>
	
	<!-- [관리자] '판매중'인 도서 개수 조회 (한진) -->
	<select id="selectStatusYCount" resultType="_int">
		select 
			   count(*)
	      from book
	     where bk_status = '판매중'
	</select>
	
	<!-- [관리자] 게시 'Y'인 도서 개수 조회 (한진) -->
	<select id="selectSelStatusYCount" resultType="_int">
		select 
			   count(*)
	      from book
	     where bk_selstatus = 'Y'
	</select>
	
	<!-- [관리자] 검색조건에 일치하는 도서 개수 조회 (한진) -->
	<select id="selectAdminSearchCount" resultType="_int">
		select
			   count(*)
		  from book
		<choose>
			<when test="condition == 'AllBook'">
				where bk_title like '%' || #{keyword} || '%'
				   or writer_name like '%' || #{keyword} || '%'
				   or bk_publish
			</when>
			<when test="condition == 'bookNo'">
				  where bk_no
			</when>		
			<when test="condition == 'bookTitle'">
				  where bk_title
			</when>
			<when test="condition == 'bookWriter'">
				  where writer_name
			</when>
			<otherwise>
				  where bk_publish
			</otherwise>
		</choose>
		like '%' || #{keyword} || '%'
	</select>
	
	<!-- [관리자] 검색조건에 일치하는 도서 목록 조회 (한진) -->
	<select id="selectAdminSearchList" resultMap="bookResult">
		select 
		       bk_no,
		       sub_cate_no,
		       bk_title,
		       bk_publish,
		       bk_date,
		       bk_price,
		       intro_originname,
		       intro_changename,
		       bk_stock,
		       bk_seldate,
		       bk_mdate,
		       bk_selstatus,
		       bk_age,
		       bk_gender,
		       bk_work,
		       bk_level,
		       bk_status,
		       writer_name,
		       writer_intro,
		       writer_origin_name,
		       writer_change_name,
		       bk_content
		  from book
		 <choose>
			<when test="condition == 'AllBook'">
				where bk_title like '%' || #{keyword} || '%'
				   or writer_name like '%' || #{keyword} || '%'
				   or bk_publish 
			</when>
			<when test="condition == 'bookNo'">
				  where bk_no
			</when>		
			<when test="condition == 'bookTitle'">
				  where bk_title
			</when>
			<when test="condition == 'bookWriter'">
				  where writer_name
			</when>
			<otherwise>
				  where bk_publish
			</otherwise>
		</choose>
		like '%' || #{keyword} || '%'
		 order
		    by 
		 <choose>
		 	<when test="array == 0">
		 		bk_date desc
		 	</when> 
		 	<when test="array == 1">
		 		bk_date asc
		 	</when>	
		 	<when test="array == 2">
		 		bk_stock desc
		 	</when>
		 	<when test="array == 3">
		 		bk_stock asc
		 	</when>
		 </choose> 
	</select>
	
	<select id="selectBook" resultMap="bookResult">
		select 
		       bk_no,
		       sub_cate_no,
		       bk_title,
		       bk_publish,
		       bk_date,
		       bk_price,
		       intro_originname,
		       intro_changename,
		       bk_stock,
		       bk_seldate,
		       bk_mdate,
		       bk_selstatus,
		       bk_age,
		       bk_gender,
		       bk_work,
		       bk_level,
		       bk_status,
		       writer_name,
		       writer_intro,
		       writer_origin_name,
		       writer_change_name,
		       bk_content
		  from book
		 where bk_no = #{bkNo}
	</select>
	
	<select id="selectCartList" resultMap="bookResult">
		select 
		       bk.bk_no,
		       sub_cate_no,
		       bk_title,
		       bk_publish,
		       bk_date,
		       bk_price,
		       intro_originname,
		       intro_changename,
		       bk_stock,
		       bk_seldate,
		       bk_mdate,
		       bk_selstatus,
		       bk_age,
		       bk_gender,
		       bk_work,
		       bk_level,
		       bk_status,
		       writer_name,
		       writer_intro,
		       writer_origin_name,
		       writer_change_name,
		       bk_content,
               bk_grade,
               cart_qty
		  from (select g.*, c.cart_qty
                  from (select bk_no, avg(grade_star) bk_grade
                        from grade
                        group by bk_no) g
                  join cart c on (c.bk_no = g.bk_no)
                  where mem_no = 2) g
		  join book bk on (g.bk_no = bk.bk_no)
         where bk.bk_no in (select bk_no
                         from cart
                         where mem_no = #{memNo})
	</select>
	
	<!-- [관리자] 도서 상태 변경 + 다중체크박스 (한진) -->
	<update id="updateBookStatus">
		update
			   book
		   set 
		   <choose>
		   		<when test="statusValue == 1">
		   			bk_status = '판매중'
		   		</when>
		   		<when test="statusValue == 2">
		   			bk_status = '품절'
		   		</when>
		   		<when test="statusValue == 3">
		   			bk_selstatus = 'Y'
		   		</when>
		   		<when test="statusValue == 4">
		   			bk_selstatus = 'N'
		   		</when>
		   </choose>
		 where bk_no = #{ bkNo }
	</update>
	
	<!-- [공통] 장바구니 유무 확인 (연지) -->
	<select id="checkCart" resultType="_int">
		select 
		       count(*)
		  from cart
         where mem_no = #{memNo}
           and bk_no = #{bkNo}
	</select>
	
	<!-- [공통] 장바구니 수량 증가 (연지) -->
	<update id="updateCartQty">
		update
			   cart
		   set 
		   	   cart_qty = cart_qty + 1
		 where mem_no = #{memNo}
           and bk_no = #{bkNo}
	</update>
	
	<!-- [공통] 장바구니 추가 (연지)-->
	<insert id="insertCart">
		insert
		  into cart
		  (
		    bk_no
		  , mem_no
		  , cart_qty
		  , cart_date
		  )
		  values
		  (
		    #{bkNo}
		  , #{memNo}
		  , 1
		  , sysdate
		  )
	</insert>
	
	<!-- [공통] 도서 삭제 (연지) -->
	<delete id="deleteCart">
		delete
		  from cart
		 where mem_no = #{memNo}
           and bk_no = #{bkNo}
	</delete>
</mapper>
